# ===========================================
# PRODUCTION + LOCAL DEVELOPMENT
# ===========================================
# Cloudflare handles SSL, nginx on port 80
# FastCGI Cache enabled for WordPress

# Global settings
client_max_body_size 256M;

# Rate limiting zones (protect against DoS)
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# WordPress auth cookie detector (used to hide sensitive endpoints from public scans)
map $http_cookie $has_wp_auth_cookie {
    default 0;
    "~*wordpress_logged_in_" 1;
    "~*wordpress_sec_" 1;
}

# Block well-known internet scanners (best-effort).
map $http_user_agent $is_known_scanner {
    default 0;
    "~*(shodan|censys|zgrab|zoomeye|netcraft)" 1;
}

# ===========================================
# FastCGI Cache Configuration
# ===========================================
# Cache path: 100MB RAM, 1GB disk, inactive 60min
fastcgi_cache_path /var/cache/nginx/fastcgi levels=1:2 keys_zone=WORDPRESS:100m inactive=60m max_size=1g;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
fastcgi_cache_background_update on;
fastcgi_cache_lock on;

# ===========================================
# WordPress - Production + Local
# ===========================================
server {
    listen 80;
    server_name vahidrajabloo.com www.vahidrajabloo.com vahidrajabloo.local;

    root /var/www/html;
    index index.php index.html;

    client_max_body_size 256M;
    include /etc/nginx/conf.d/security_headers.inc;

    # Cache bypass conditions
    set $skip_cache 0;
    set $block_public_rest 0;

    if ($is_known_scanner = 1) {
        return 403;
    }

    # Don't cache POST requests
    if ($request_method = POST) {
        set $skip_cache 1;
    }

    # Don't cache URLs with query strings
    if ($query_string != "") {
        set $skip_cache 1;
    }

    # Hide index.php?rest_route=... for public users
    if ($arg_rest_route != "") {
        set $block_public_rest 1;
        set $skip_cache 1;
    }

    if ($has_wp_auth_cookie = 1) {
        set $block_public_rest 0;
    }

    if ($block_public_rest = 1) {
        return 404;
    }

    # Don't cache admin, login, wp-json
    if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml|/wp-json/)") {
        set $skip_cache 1;
    }

    # Don't cache for logged-in users or recent commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $skip_cache 1;
    }

    # Don't cache WooCommerce pages (if installed)
    if ($request_uri ~* "/cart.*|/checkout.*|/my-account.*") {
        set $skip_cache 1;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # Obfuscated public paths: /assets -> wp-content, /core -> wp-includes
    location ^~ /assets/ {
        alias /var/www/html/wp-content/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        include /etc/nginx/conf.d/security_headers.inc;
        log_not_found off;
        access_log off;
    }

    location ^~ /core/ {
        alias /var/www/html/wp-includes/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        include /etc/nginx/conf.d/security_headers.inc;
        log_not_found off;
        access_log off;
    }

    # Block common WordPress fingerprint files/endpoints
    location = /xmlrpc.php { return 404; }
    location = /readme.html { return 404; }
    location = /license.txt { return 404; }
    location = /wp-links-opml.php { return 404; }
    location = /wlwmanifest.xml { return 404; }
    location = /wp-trackback.php { return 404; }
    location = /wp-config.php { return 404; }
    location ~* ^/wp-admin/(install|upgrade)\.php$ { return 404; }

    # Hide REST API endpoints from non-authenticated visitors/scanners
    location = /wp-json {
        if ($has_wp_auth_cookie = 0) { return 404; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ^~ /wp-json/ {
        if ($has_wp_auth_cookie = 0) { return 404; }
        try_files $uri $uri/ /index.php?$args;
    }

    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    location = /wp-login.php {
        return 403;
    }

    # Public AJAX endpoint alias (hides canonical /wp-admin/admin-ajax.php path).
    location = /ajax-endpoint {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/wp-admin/admin-ajax.php;
        fastcgi_read_timeout 300;
        fastcgi_hide_header X-Powered-By;
        include /etc/nginx/conf.d/security_headers.inc;
    }

    location = /wp-admin/admin-ajax.php {
        if ($has_wp_auth_cookie = 0) { return 404; }
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/wp-admin/admin-ajax.php;
        fastcgi_read_timeout 300;
        fastcgi_hide_header X-Powered-By;
        include /etc/nginx/conf.d/security_headers.inc;
    }

    location = /wp-admin {
        if ($http_cookie !~* "wordpress_logged_in_") {
            return 302 https://app.vahidrajabloo.com/admin;
        }
        return 301 /wp-admin/;
    }

    location = /wp-admin/ {
        if ($http_cookie !~* "wordpress_logged_in_") {
            return 302 https://app.vahidrajabloo.com/admin;
        }
        try_files $uri $uri/ /index.php?$args;
    }

    # Allow public static assets from canonical WordPress paths.
    # Blocking these paths breaks theme/plugin CSS/JS for anonymous visitors.
    location ^~ /wp-content/ {
        try_files $uri $uri/ =404;
    }

    location ^~ /wp-includes/ {
        try_files $uri $uri/ =404;
    }

    # Never execute PHP from wp-content/wp-includes.
    location ~* ^/(wp-content|wp-includes)/.*\.php$ { return 404; }

    location ~* ^/(assets|core)/.*\.php$ { return 404; }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
        fastcgi_hide_header X-Powered-By;
        
        # Buffer settings for Elementor
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_busy_buffers_size 32k;

        # FastCGI Cache settings
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;

        # Add cache status header (for debugging)
        add_header X-FastCGI-Cache $upstream_cache_status;
        add_header X-Cache-Bypass $skip_cache;
        include /etc/nginx/conf.d/security_headers.inc;
    }

    # Static files - browser cache
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        include /etc/nginx/conf.d/security_headers.inc;
        log_not_found off;
        access_log off;
        try_files $uri =404;
    }

    # Security - deny hidden files
    location ~ /\. {
        deny all;
    }

    # Note: Cache purge requires nginx-plus or special modules
    # To clear cache manually: docker exec nginx rm -rf /var/cache/nginx/fastcgi/*
}

# ===========================================
# Laravel App - Production + Local
# ===========================================
server {
    listen 80;
    server_name app.vahidrajabloo.com app.vahidrajabloo.local;

    root /var/www/laravel/public;
    index index.php index.html;

    client_max_body_size 256M;
    include /etc/nginx/conf.d/security_headers.inc;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass laravel:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
        fastcgi_hide_header X-Powered-By;
    }

    # Livewire routes - must be before static files rule
    location ^~ /livewire/ {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Static files - browser cache (excluding /livewire/)
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        include /etc/nginx/conf.d/security_headers.inc;
        log_not_found off;
        access_log off;
        try_files $uri =404;
    }

    location ~ /\. {
        deny all;
    }
}
