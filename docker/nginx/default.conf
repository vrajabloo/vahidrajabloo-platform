# ===========================================
# PRODUCTION + LOCAL DEVELOPMENT
# ===========================================
# Cloudflare handles SSL, nginx on port 80
# FastCGI Cache enabled for WordPress

# Global settings
client_max_body_size 256M;

# Rate limiting zones (protect against DoS)
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# ===========================================
# FastCGI Cache Configuration
# ===========================================
# Cache path: 100MB RAM, 1GB disk, inactive 60min
fastcgi_cache_path /var/cache/nginx/fastcgi levels=1:2 keys_zone=WORDPRESS:100m inactive=60m max_size=1g;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
fastcgi_cache_background_update on;
fastcgi_cache_lock on;

# ===========================================
# WordPress - Production + Local
# ===========================================
server {
    listen 80;
    server_name vahidrajabloo.com www.vahidrajabloo.com vahidrajabloo.local;

    root /var/www/html;
    index index.php index.html;

    client_max_body_size 256M;

    # Cache bypass conditions
    set $skip_cache 0;

    # Don't cache POST requests
    if ($request_method = POST) {
        set $skip_cache 1;
    }

    # Don't cache URLs with query strings
    if ($query_string != "") {
        set $skip_cache 1;
    }

    # Don't cache admin, login, wp-json
    if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml|/wp-json/)") {
        set $skip_cache 1;
    }

    # Don't cache for logged-in users or recent commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $skip_cache 1;
    }

    # Don't cache WooCommerce pages (if installed)
    if ($request_uri ~* "/cart.*|/checkout.*|/my-account.*") {
        set $skip_cache 1;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
        
        # Buffer settings for Elementor
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_busy_buffers_size 32k;

        # FastCGI Cache settings
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;

        # Add cache status header (for debugging)
        add_header X-FastCGI-Cache $upstream_cache_status;
        add_header X-Cache-Bypass $skip_cache;
    }

    # Static files - browser cache
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        log_not_found off;
        access_log off;
        try_files $uri =404;
    }

    # Security - deny hidden files
    location ~ /\. {
        deny all;
    }

    # Note: Cache purge requires nginx-plus or special modules
    # To clear cache manually: docker exec nginx rm -rf /var/cache/nginx/fastcgi/*
}

# ===========================================
# Laravel App - Production + Local
# ===========================================
server {
    listen 80;
    server_name app.vahidrajabloo.com app.vahidrajabloo.local;

    root /var/www/laravel/public;
    index index.php index.html;

    client_max_body_size 256M;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass laravel:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
    }

    # Static files - browser cache
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        log_not_found off;
        access_log off;
        try_files $uri =404;
    }

    location ~ /\. {
        deny all;
    }
}
